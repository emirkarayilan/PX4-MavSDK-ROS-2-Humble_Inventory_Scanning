#!/usr/bin/env python3
# Drone kamerasından gelen görüntülerde kutu algılama ve takip sistemi

import rclpy
from rclpy.node import Node
from sensor_msgs.msg import Image
from cv_bridge import CvBridge
import cv2
import numpy as np

class KutuAlgilama(Node):
    """
    Drone kamerasından gelen görüntülerde kahverengi kutuları algılayan
    ve her kutuyu sadece bir kez kaydeden sınıf
    """
    
    def __init__(self):
        super().__init__('kutu_algilama')
        
        # ROS görüntülerini OpenCV formatına çevirmek için köprü
        self.bridge = CvBridge()
        
        # Şu anda bir kutu görülüyor mu?
        self.kutu_var = False
        
        # Animasyon için sayaç
        self.son_algilama_sayaci = 0
        
        # Kaç tane görüntü aldık?
        self.goruntu_sayisi = 0
        
        # Daha önce algılanan kutuların listesi (her kutu bir kez kaydedilecek)
        self.tanınan_kutular = []
        
        # Şu anda görülen kutunun kaç frame'dir ekranda olduğunu tutar
        self.aktif_kutu_sayaci = 0
        
        # Bir kutuyu kaydetmek için kaç frame görmemiz gerekiyor? (false positive önleme)
        self.onay_esigi = 15
        
        # Şu anda görülen kutunun konumu (x, y, genişlik, yükseklik)
        self.mevcut_konum = None
        
        # Mesafe ve açı kontrolleri için parametreler
        self.min_kutu_boyutu = 8000  # Piksel cinsinden minimum alan (50cm veya daha yakin)
        self.max_kutu_boyutu = 100000  # Maksimum alan (cok fazla yakin degil)
        self.min_merkez_x = 0.25  # Ekranin sol %25'i
        self.max_merkez_x = 0.75  # Ekranin sag %75'i (orta bant)
        
        # Kamera yayını hangi topic'ten gelecek?
        kamera_topic = '/front_camera/image_raw'
        
        # Kullanıcıya bilgi ver
        print("\nKutu Algilama Sistemi")
        print(f"Kamera topic: {kamera_topic}")
        
        # Sistemdeki tüm topic'leri kontrol et
        self.get_logger().info('Mevcut image topicler kontrol ediliyor...')
        import time
        time.sleep(1)  # Topic listesinin yüklenmesini bekle
        
        # Sistemdeki tüm topic isimlerini ve tiplerini al
        topic_names_and_types = self.get_topic_names_and_types()
        
        # Sadece Image tipindeki topic'leri filtrele
        image_topics = [name for name, types in topic_names_and_types 
                       if 'sensor_msgs/msg/Image' in types]
        
        # Bulunan image topic'lerini ekrana yazdır
        if image_topics:
            print("\nBulunan image topicler:")
            for i, topic in enumerate(image_topics, 1):
                print(f"  {i}. {topic}")
        
        # Kamera topic'ine abone ol (her yeni görüntü geldiğinde callback çağrılacak)
        self.subscription = self.create_subscription(
            Image,
            kamera_topic,
            self.goruntu_callback,
            10)  # Kuyruk boyutu 10
        
        # Her 3 saniyede bir kamera bağlantısını kontrol et
        self.timer = self.create_timer(3.0, self.topic_kontrol)
        
        # Kullanıcıya bilgi ver
        self.get_logger().info(f'{kamera_topic} topicine abone olundu')
        print("Sadece 1 kutu algilanacak ve bir kere kaydedilecek")
        print("Durdurmak icin: Ctrl+C\n")
    
    def topic_kontrol(self):
        """
        Kamera bağlantısının çalışıp çalışmadığını kontrol eder
        Eğer hiç görüntü gelmiyorsa kullanıcıyı uyarır
        """
        if self.goruntu_sayisi == 0:
            # Hala hiç görüntü almadık
            self.get_logger().warning('Henuz goruntu alinamadi')
            print("Kamera goruntusu gelmiyor. Gazebo ve drone kontrolu yapin.")
        else:
            # Görüntü gelmeye başladı, artık kontrol etmeye gerek yok
            self.get_logger().info(f'Kamera calisiyor ({self.goruntu_sayisi} goruntu)')
            self.timer.cancel()
    
    def mesafe_ve_aci_uygun_mu(self, x, y, w, h, alan, goruntu_genisligi):
        """
        Kutunun mesafe ve açısının uygun olup olmadığını kontrol eder
        Mesafe 50cm'den KÜÇÜK (kutu yakın) olmalı
        
        Parametreler:
            x, y: Kutunun sol üst köşe koordinatları
            w, h: Kutunun genişlik ve yüksekliği
            alan: Kutunun alanı (piksel)
            goruntu_genisligi: Görüntünün genişliği
            
        Döndürür:
            (uygun_mu, mesafe_durumu, aci_durumu): 
                - uygun_mu: Koşullar sağlanıyor mu? (True/False)
                - mesafe_durumu: "Uygun", "Cok uzak", "Cok yakin"
                - aci_durumu: "Uygun", "Sol", "Sag"
        """
        
        # 1. MESAFE KONTROLÜ (kutunun alanına bakarak)
        # Büyük alan = yakın mesafe (UYGUN), küçük alan = uzak mesafe (UYGUN DEĞİL)
        # Kutu 50cm'den YAKIN olmali (büyük alan)
        mesafe_uygun = alan >= self.min_kutu_boyutu and alan <= self.max_kutu_boyutu
        
        if alan < self.min_kutu_boyutu:
            mesafe_durumu = "Uzak"  # 50cm'den uzak
        elif alan > self.max_kutu_boyutu:
            mesafe_durumu = "Cok yakin"  # Fazla yakın
        else:
            mesafe_durumu = "Yakin"  # 50cm veya daha yakın (UYGUN)
        
        # 2. ACI KONTROLÜ (kutunun ekrandaki konumuna bakarak)
        # Kutunun merkez noktasını hesapla
        merkez_x = x + w // 2
        
        # Merkezin görüntüdeki normalize pozisyonu (0.0 = sol, 1.0 = sağ)
        normalize_pozisyon = merkez_x / goruntu_genisligi
        
        # Orta bantta mı? (yaklaşık 75-90 derece açı için)
        aci_uygun = self.min_merkez_x <= normalize_pozisyon <= self.max_merkez_x
        
        if normalize_pozisyon < self.min_merkez_x:
            aci_durumu = "Sol"
        elif normalize_pozisyon > self.max_merkez_x:
            aci_durumu = "Sag"
        else:
            aci_durumu = "Uygun"
        
        # Her iki koşul da sağlanmalı
        uygun_mu = mesafe_uygun and aci_uygun
        
        return uygun_mu, mesafe_durumu, aci_durumu
    
    def kutu_zaten_tanindi_mi(self, x, y, w, h):
        """
        Verilen konumdaki kutunun daha önce kaydedilip kaydedilmediğini kontrol eder
        
        Parametreler:
            x, y: Kutunun sol üst köşe koordinatları
            w, h: Kutunun genişlik ve yüksekliği
            
        Döndürür:
            True: Bu kutu daha önce kaydedilmiş
            False: Bu yeni bir kutu
        """
        # Tüm kaydedilmiş kutuları kontrol et
        for tanınan in self.tanınan_kutular:
            tx, ty, tw, th = tanınan
            
            # Her iki kutunun merkez noktalarını hesapla
            merkez1_x = x + w // 2
            merkez1_y = y + h // 2
            merkez2_x = tx + tw // 2
            merkez2_y = ty + th // 2
            
            # İki merkez arasındaki mesafeyi hesapla (Pisagor teoremi)
            mesafe = np.sqrt((merkez1_x - merkez2_x)**2 + (merkez1_y - merkez2_y)**2)
            
            # Boyutlar ne kadar farklı?
            boyut_farki = abs(w - tw) + abs(h - th)
            
            # Eğer merkezler yakınsa ve boyutlar benzerse, bu aynı kutu demektir
            if mesafe < 100 and boyut_farki < 50:
                return True  # Evet, bu kutu zaten kaydedilmiş
        
        return False  # Hayır, bu yeni bir kutu
    
    def kutu_algilama(self, goruntu):
        """
        Görüntüde kahverengi kutu arar ve işaretler
        
        Parametreler:
            goruntu: OpenCV formatında BGR görüntü
            
        Döndürür:
            islenmiş_goruntu: Üzerine çizimler yapılmış görüntü
            kutu_bulundu: Yeni bir kutu bulundu mu? (True/False)
        """
        
        # BGR görüntüyü HSV (Hue-Saturation-Value) renk uzayına çevir
        # HSV'de renk aralıkları belirlemek daha kolay
        hsv = cv2.cvtColor(goruntu, cv2.COLOR_BGR2HSV)
        
        # Kahverengi/karton rengi için HSV aralıkları tanımla
        # İlk aralık: Orta tonlar
        alt_kahve1 = np.array([5, 30, 30])   # H, S, V minimum değerleri
        ust_kahve1 = np.array([30, 255, 255])  # H, S, V maksimum değerleri
        
        # İkinci aralık: Koyu tonlar
        alt_kahve2 = np.array([0, 30, 30])
        ust_kahve2 = np.array([10, 255, 255])
        
        # Üçüncü aralık: Sarımsı açık tonlar
        alt_sari = np.array([20, 40, 80])
        ust_sari = np.array([35, 255, 255])
        
        # Her aralık için ayrı maske oluştur (beyaz=eşleşen piksel, siyah=eşleşmeyen)
        maske1 = cv2.inRange(hsv, alt_kahve1, ust_kahve1)
        maske2 = cv2.inRange(hsv, alt_kahve2, ust_kahve2)
        maske3 = cv2.inRange(hsv, alt_sari, ust_sari)
        
        # Üç maskeyi birleştir (herhangi bir aralığa uyan pikseller beyaz olacak)
        maske = cv2.bitwise_or(cv2.bitwise_or(maske1, maske2), maske3)
        
        # Gürültü temizleme işlemleri
        # Küçük kernel: Detayları korumak için
        kernel_kucuk = np.ones((3, 3), np.uint8)
        # Büyük kernel: Büyük alanları doldurmak için
        kernel_buyuk = np.ones((7, 7), np.uint8)
        
        # Morfolojik işlemler ile gürültüyü temizle
        # CLOSE: Küçük delikleri kapat
        maske = cv2.morphologyEx(maske, cv2.MORPH_CLOSE, kernel_buyuk)
        # OPEN: Küçük noktaları temizle
        maske = cv2.morphologyEx(maske, cv2.MORPH_OPEN, kernel_kucuk)
        # Gaussian blur ile kenarları yumuşat
        maske = cv2.GaussianBlur(maske, (5, 5), 0)
        
        # Maskedeki beyaz bölgelerin dış hatlarını bul
        konturlar, _ = cv2.findContours(maske, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
        
        # Henüz kutu bulunmadı
        kutu_bulundu = False
        
        # Orijinal görüntünün kopyasını al (üzerine çizim yapacağız)
        sonuc_goruntu = goruntu.copy()
        
        # En büyük kutunun alanını ve bilgilerini takip et
        en_buyuk_alan = 0
        en_buyuk_kutu = None
        
        # Her konturu kontrol et
        for kontur in konturlar:
            # Konturun alanını hesapla (piksel cinsinden)
            alan = cv2.contourArea(kontur)
            
            # Çok küçük nesneleri görmezden gel (gürültü olabilir)
            if alan > 500:
                # Konturu çevreleyen dikdörtgeni al
                x, y, w, h = cv2.boundingRect(kontur)
                
                # En-boy oranını hesapla
                en_boy_orani = float(w) / h
                
                # Kutu şeklinde mi? (çok uzun/ince olmamalı)
                if 0.3 < en_boy_orani < 4.0:
                    # Bu konturu en büyük kutu adayı olarak kaydet
                    if alan > en_buyuk_alan:
                        en_buyuk_alan = alan
                        en_buyuk_kutu = (x, y, w, h, alan)
        
        # En büyük kutuyu bulduk mu?
        if en_buyuk_kutu:
            x, y, w, h, alan = en_buyuk_kutu
            
            # Bu kutu daha önce kaydedilmiş mi kontrol et
            zaten_tanindi = self.kutu_zaten_tanindi_mi(x, y, w, h)
            
            if zaten_tanindi:
                # Bu kutu zaten sistemde var - GRİ renkle işaretle
                
                # Dış çerçeve (kalın)
                cv2.rectangle(sonuc_goruntu, (x-5, y-5), (x+w+5, y+h+5), (128, 128, 128), 4)
                # İç çerçeve (ince)
                cv2.rectangle(sonuc_goruntu, (x, y), (x+w, y+h), (100, 100, 100), 2)
                
                # Etiket kutusu için boyutlar
                etiket_w = 280
                etiket_h = 40
                etiket_x = max(x, 10)  # Ekran dışına çıkmasın
                etiket_y = max(y - 50, 10)
                
                # Gri etiket kutusu (dolu)
                cv2.rectangle(sonuc_goruntu, 
                             (etiket_x, etiket_y), 
                             (etiket_x + etiket_w, etiket_y + etiket_h), 
                             (100, 100, 100), -1)
                
                # Etiket kutusunun çerçevesi
                cv2.rectangle(sonuc_goruntu, 
                             (etiket_x, etiket_y), 
                             (etiket_x + etiket_w, etiket_y + etiket_h), 
                             (200, 200, 200), 2)
                
                # "Zaten kaydedildi" yazısı
                cv2.putText(sonuc_goruntu, 'Zaten kaydedildi', 
                           (etiket_x + 10, etiket_y + 28),
                           cv2.FONT_HERSHEY_SIMPLEX, 0.8, (255, 255, 255), 2)
                
                # Bu yeni bir kutu değil, sayma
                kutu_bulundu = False
                
            else:
                # Bu yeni bir kutu! - YEŞİL renkle işaretle
                
                # Dış çerçeve (kalın, parlak yeşil)
                cv2.rectangle(sonuc_goruntu, (x-5, y-5), (x+w+5, y+h+5), (0, 255, 0), 4)
                # İç çerçeve (ince, koyu yeşil)
                cv2.rectangle(sonuc_goruntu, (x, y), (x+w, y+h), (0, 200, 0), 2)
                
                # Etiket kutusu için boyutlar
                etiket_w = 280
                etiket_h = 40
                etiket_x = max(x, 10)
                etiket_y = max(y - 50, 10)
                
                # Yeşil etiket kutusu (dolu)
                cv2.rectangle(sonuc_goruntu, 
                             (etiket_x, etiket_y), 
                             (etiket_x + etiket_w, etiket_y + etiket_h), 
                             (0, 200, 0), -1)
                
                # Etiket kutusunun beyaz çerçevesi
                cv2.rectangle(sonuc_goruntu, 
                             (etiket_x, etiket_y), 
                             (etiket_x + etiket_w, etiket_y + etiket_h), 
                             (255, 255, 255), 2)
                
                # "Kutu algılandı" yazısı
                cv2.putText(sonuc_goruntu, 'Kutu algilandi', 
                           (etiket_x + 10, etiket_y + 28),
                           cv2.FONT_HERSHEY_SIMPLEX, 0.8, (255, 255, 255), 2)
                
                # Kutunun altına alan ve boyut bilgisi yaz
                cv2.putText(sonuc_goruntu, f'Alan: {int(alan)} | {w}x{h} px', 
                           (x, y+h+20),
                           cv2.FONT_HERSHEY_SIMPLEX, 0.5, (0, 255, 0), 1)
                
                # Kutunun merkezine nokta işareti koy
                merkez_x = x + w // 2
                merkez_y = y + h // 2
                # İç nokta (dolu yeşil daire)
                cv2.circle(sonuc_goruntu, (merkez_x, merkez_y), 6, (0, 255, 0), -1)
                # Dış halka (beyaz çember)
                cv2.circle(sonuc_goruntu, (merkez_x, merkez_y), 10, (255, 255, 255), 2)
                
                # Yeni kutu bulundu
                kutu_bulundu = True
                
                # Bu kutunun konumunu kaydet (onay için)
                self.mevcut_konum = (x, y, w, h)
        
        # Üst durum çubuğu ve bilgilendirme
        yukseklik, genislik = goruntu.shape[:2]
        
        # Sol alt köşeye kaydedilen kutu sayısını yaz
        info_text = f'Kayitli: {len(self.tanınan_kutular)} kutu'
        # Önce beyaz gölge (okunabilirlik için)
        cv2.putText(sonuc_goruntu, info_text, 
                   (10, yukseklik - 15),
                   cv2.FONT_HERSHEY_SIMPLEX, 0.6, (255, 255, 255), 2)
        # Sonra siyah yazı
        cv2.putText(sonuc_goruntu, info_text, 
                   (10, yukseklik - 15),
                   cv2.FONT_HERSHEY_SIMPLEX, 0.6, (0, 0, 0), 1)
 
        if kutu_bulundu:
            # Yeni kutu bulundu - yeşil banner
            cv2.rectangle(sonuc_goruntu, (0, 0), (genislik, 50), (0, 180, 0), -1)
            cv2.putText(sonuc_goruntu, 'Yeni kutu bulundu', 
                       (20, 35),
                       cv2.FONT_HERSHEY_SIMPLEX, 1.2, (255, 255, 255), 2)
        else:
            # Kutu aranıyor - kırmızı banner
            cv2.rectangle(sonuc_goruntu, (0, 0), (genislik, 50), (0, 0, 180), -1)
            cv2.putText(sonuc_goruntu, 'Araniyor', 
                       (20, 35),
                       cv2.FONT_HERSHEY_SIMPLEX, 1.2, (255, 255, 255), 2)
            
            # Arama animasyonu (nokta sayısı değişir)
            nokta_sayisi = (self.son_algilama_sayaci // 10) % 4
            cv2.putText(sonuc_goruntu, '.' * nokta_sayisi, 
                       (genislik - 80, 35),
                       cv2.FONT_HERSHEY_SIMPLEX, 1.5, (255, 255, 255), 2)
        
        return sonuc_goruntu, kutu_bulundu
    
    def goruntu_callback(self, msg):
        """
        Kameradan her yeni görüntü geldiğinde çağrılır
        Görüntüyü işler ve kutu algılama yapar
        
        Parametreler:
            msg: ROS Image mesajı
        """
        try:
            # Kaç görüntü aldığımızı say
            self.goruntu_sayisi += 1
            
            # İlk görüntü geldiğinde bilgi ver
            if self.goruntu_sayisi == 1:
                self.get_logger().info('Ilk goruntu alindi')
                print(f"\nKamera baglantisi basarili")
                print(f"Goruntu boyutu: {msg.width}x{msg.height}")
                print(f"Encoding: {msg.encoding}\n")
            
            # ROS Image mesajını OpenCV formatına çevir
            try:
                # Önce BGR8 formatını dene (en yaygın)
                cv_goruntu = self.bridge.imgmsg_to_cv2(msg, desired_encoding='bgr8')
            except Exception as e1:
                # BGR8 çalışmadı, RGB8 dene
                self.get_logger().warning(f'bgr8 basarisiz, rgb8 deneniyor: {e1}')
                try:
                    cv_goruntu = self.bridge.imgmsg_to_cv2(msg, desired_encoding='rgb8')
                    # RGB'yi BGR'ye çevir (OpenCV BGR kullanır)
                    cv_goruntu = cv2.cvtColor(cv_goruntu, cv2.COLOR_RGB2BGR)
                except Exception as e2:
                    # O da çalışmadı, encoding belirtmeden dene
                    self.get_logger().error(f'rgb8 de basarisiz: {e2}')
                    cv_goruntu = self.bridge.imgmsg_to_cv2(msg)
            
            # Görüntü boş mu kontrol et
            if cv_goruntu is None or cv_goruntu.size == 0:
                self.get_logger().error('Goruntu bos')
                return
            
            # Kutu algılama fonksiyonunu çağır
            islenmiş_goruntu, kutu_var = self.kutu_algilama(cv_goruntu)
            
            # Animasyon sayacını artır
            self.son_algilama_sayaci += 1
            
            # Yeni kutu algılandıysa işlemleri yap
            if kutu_var and self.mevcut_konum:
                # Bu kutu kaç frame'dir ekranda?
                self.aktif_kutu_sayaci += 1
                
                # Yeterince uzun süre gördük mü? (false positive önleme)
                if self.aktif_kutu_sayaci >= self.onay_esigi:
                    x, y, w, h = self.mevcut_konum
                    
                    # Kutuyu envantere ekle
                    self.tanınan_kutular.append((x, y, w, h))
                    self.get_logger().info(f'Yeni kutu kaydedildi! Toplam: {len(self.tanınan_kutular)}')
                    print(f">>> Kutu #{len(self.tanınan_kutular)} envantere eklendi")
                    
                    # Sayaçları sıfırla (yeni kutu aramaya devam)
                    self.aktif_kutu_sayaci = 0
                    self.mevcut_konum = None
            else:
                # Kutu kayboldu veya zaten kaydedilmiş, sayacı sıfırla
                self.aktif_kutu_sayaci = 0
                self.mevcut_konum = None
            
            # Durum değişikliklerini logla
            if kutu_var and not self.kutu_var:
                self.get_logger().info('Yeni kutu algilandi')
            elif not kutu_var and self.kutu_var:
                self.get_logger().info('Kutu gorus alanından cikti')
            
            # Kutu durumunu güncelle
            self.kutu_var = kutu_var
            
            # Görüntüyü pencerede göster
            pencere_adi = 'Drone Kamera - Kutu Algilama'
            cv2.namedWindow(pencere_adi, cv2.WINDOW_NORMAL)
            cv2.imshow(pencere_adi, islenmiş_goruntu)
            
            # Klavye girdisini kontrol et (10ms bekle)
            key = cv2.waitKey(10)
            if key == 27:  # ESC tuşu
                self.get_logger().info('ESC tusuna basildi, kapatiliyor')
                raise KeyboardInterrupt
            
        except KeyboardInterrupt:
            # Kullanıcı programı durdurmak istedi
            raise
        except Exception as e:
            # Beklenmeyen bir hata oluştu
            self.get_logger().error(f'Hata: {e}')
            import traceback
            traceback.print_exc()

def main(args=None):
    """
    Programın giriş noktası
    ROS2 node'unu başlatır ve çalıştırır
    """
    # NumPy ve diğer kütüphanelerin uyarılarını kapat
    import warnings
    warnings.filterwarnings('ignore')
    
    # ROS2'yi başlat
    rclpy.init(args=args)
    
    # Kutu algılama node'unu oluştur
    algilayici = KutuAlgilama()
    
    try:
        # Node'u çalıştır (sürekli döngü, callback'ler çağrılır)
        rclpy.spin(algilayici)
    except KeyboardInterrupt:
        # Kullanıcı Ctrl+C'ye bastı
        print("\nProgram durduruldu")
    finally:
        # Temizlik işlemleri
        cv2.destroyAllWindows()  # Tüm OpenCV pencerelerini kapat
        algilayici.destroy_node()  # Node'u temizle
        rclpy.shutdown()  # ROS2'yi kapat

if __name__ == '__main__':
    # Eğer bu dosya direkt çalıştırılıyorsa (import edilmiyorsa)
    main()
